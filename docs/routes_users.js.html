<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>routes/users.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-app.html">app</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-routers_users.html">routers/users</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">routes/users.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** Express router providing user related routes
 * @module routers/users
 * @requires express
 */
var express = require('express');
var router = express.Router();
const Joi = require('joi');
const schema = Joi.object().keys({
  username: Joi.string()
    .email()
    .required(),
  password: Joi.string().regex(/^[a-zA-Z0-9]{3,30}$/)
});

/**
 * middleware serving "msg" parse.
 * @name get/login
 * @function
 * @memberof module:routers/users~usersRouter
 * @inner
 * @param {string} path - Express path
 * @param {callback} middleware - Express middleware.
 */
router.use((req, res, next) => {
  if (req.query.msg === 'fail') {
    res.locals.msg = 'Username Password not matched!';
  } else {
    res.locals.msg = '';
  }
  console.log('msg', res.locals.msg);
  next();
});

/**
 * Route serving login form.
 * @name get/
 * @function
 * @memberof module:routers/users~usersRouter
 * @inner
 * @param {string} path - Express path
 * @param {callback} middleware - Express middleware.
 */

router.get('/', (req, res, next) => {
  res.send('user page...  TBD ');
});

/**
 * Route serving login form.
 * @name get/login
 * @function
 * @memberof module:routers/users~usersRouter
 * @inner
 * @param {string} path - Express path
 * @param {callback} middleware - Express middleware.
 */
router.get('/login', (req, res) => {
  // console.log(req.query);
  res.render('login');
});

router.post('/login_process', (req, res, next) => {
  const username = req.body.username;
  const password = req.body.password;

  Joi.validate(
    { username: username, password: password },
    schema,
    (err, value) => {
      if (err) {
        // res.status(422).json({
        //   status: 'error',
        //   message: 'invalid username/password',
        //   data: userData
        // });
        res.redirect('login?msg=fail');
      } else {
        if (password === 'xxxx') {
          res.cookie('username', username);
          res.redirect('welcome');
        } else {
          res.redirect('login?msg=fail');
        }
      }
    }
  );
});

/* Rendering welcome page, pass username via cookie */
router.get('/welcome', (req, res, next) => {
  res.render('welcome', {
    username: req.cookies.username
  });
});

/* Log out page, redirect to login page, clear cookie */
router.get('/logout', (req, res, next) => {
  res.clearCookie('username');
  res.redirect('login');
});

module.exports = router;
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Oct 09 2018 14:11:15 GMT-0400 (Eastern Daylight Time) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
